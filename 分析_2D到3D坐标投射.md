# 2D世界坐标到3D世界坐标投射分析

## 概述

这两个文件展示了一个巧妙的方法，将2D游戏世界中的坐标和目标投射到3D模型上，使3D炮塔能够在2D游戏世界中正确瞄准和射击。

## 关键文件分析

### 1. `globalSkillData/turret-bt-7270.gd` - 主要实现文件

这是实现2D到3D坐标投射的核心文件。主要机制在`_process`函数中实现：

#### 核心投射代码（第47-54行）
```gdscript
func _process(delta: float) -> void:
    # 将3D标记点投影到2D世界
    var tempPos = sub_viewport_container.global_position+camera_3d.unproject_position(marker_3d.global_position)*scale
    marker_2d.global_position = tempPos
    
    # 计算炮塔旋转位置在2D世界中的位置
    swivelPos = sub_viewport_container.global_position+camera_3d.unproject_position(pos.global_position)*scale
    
    # 更新粒子效果和碰撞检测位置
    gpu_particles_2d.global_position = marker_2d.global_position
    gpu_particles_2d.global_rotation = swivels.rotation.y*-1
    eye.global_position = marker_2d.global_position
    eye.rotation = -swivels.rotation.y
```

#### 技术原理

1. **SubViewport容器**：使用`SubViewportContainer`和`SubViewport`来在2D世界中渲染3D场景
2. **Camera3D.unproject_position()**：这是关键函数，将3D世界中的坐标转换为2D屏幕坐标
3. **坐标同步**：
   - `marker_3d`（3D空间中的标记点）被投影到2D空间，用于确定炮塔在2D世界中的位置
   - `pos`（3D炮塔旋转中心）被投影到2D空间，用于计算瞄准方向
   - 2D元素（如碰撞检测区域`eye`和粒子效果`gpu_particles_2d`）的位置与3D模型的投影位置同步

#### 瞄准和射击机制（第74-114行）
```gdscript
func state_logic_aim():
    # 获取2D世界中的目标
    var target = targetArray[0]
    
    # 计算2D世界中的瞄准方向
    var targetDir = (target.global_position-swivelPos)
    var targetAngle =targetDir.angle()*-1
    
    # 将2D角度应用到3D模型上
    swivels.rotation.y = lerp_angle(swivels.rotation.y,targetAngle,0.02)
```

### 2. `skill/scene/BT-7271.gd` - 机器人召唤技能

这个文件主要负责召唤机器人，但不直接处理2D到3D的投射。它调用机器人的`_setData`方法设置初始位置：

```gdscript
# 设置机器人在2D世界中的位置
robot_instance._setData(spawn_position, speed, liveTime, trigger_pulse)
```

## 投射流程总结

1. **3D模型渲染**：3D炮塔模型在`SubViewport`中渲染，这是一个独立的3D场景
2. **坐标投影**：使用`Camera3D.unproject_position()`将3D坐标转换为2D屏幕坐标
3. **位置同步**：将投影后的2D坐标应用到2D游戏世界中的相关元素上
4. **方向计算**：在2D世界中计算瞄准方向和角度
5. **旋转应用**：将2D计算出的角度应用到3D模型的Y轴旋转上
6. **效果同步**：粒子效果和碰撞检测区域跟随3D模型的投影位置

## 关键技术点

- **SubViewport**：允许在2D世界中嵌入3D场景
- **Camera3D.unproject_position()**：核心函数，实现3D到2D的坐标转换
- **坐标偏移计算**：`sub_viewport_container.global_position + camera_3d.unproject_position(...) * scale`
- **角度转换**：2D角度直接应用于3D模型的Y轴旋转，因为两者都是围绕垂直轴旋转
- **实时同步**：每一帧都更新投影位置，确保2D和3D元素保持同步

这种方法使得开发者可以在2D游戏世界中使用3D模型，同时保持2D游戏的物理和碰撞检测逻辑。